# å‘½ç†AIåŠ©æ‰‹ - èåˆæ–¹æ¡ˆ

## ğŸ¯ ç›®æ ‡

å°†ã€Œå¯¹è¯å¼AIäº¤äº’ã€å’Œã€ŒKçº¿å¯è§†åŒ–ã€æ¦‚å¿µèåˆåˆ°ç°æœ‰ myfate.org é¡¹ç›®ä¸­ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## ğŸ“Š ç°æœ‰é¡¹ç›® vs æ–°æ¦‚å¿µå¯¹æ¯”

| åŠŸèƒ½ | ç°æœ‰é¡¹ç›® (myfate.org) | æ–°æ¦‚å¿µ (å‘½ç†AIåŠ©æ‰‹) | èåˆæ–¹æ¡ˆ |
|-----|---------------------|-------------------|---------|
| å…«å­—åˆ†æ | âœ… å®Œæ•´å®ç° | éœ€è¦ | å¤ç”¨ç°æœ‰æœåŠ¡ |
| äº”è¡Œåˆ†æ | âœ… å®Œæ•´å®ç° | éœ€è¦ | å¤ç”¨ç°æœ‰æœåŠ¡ |
| æµå¹´è¿åŠ¿ | âœ… LiunianAnalysisService | éœ€è¦ | å¤ç”¨å¹¶å¢å¼ºå±•ç¤º |
| æ—¥å† | âœ… CalendarService | éœ€è¦ | å¤ç”¨ |
| é£æ˜Ÿ | âœ… FeiXingService | å¯é€‰ | ä¿ç•™ |
| ç”¨æˆ·æ¡£æ¡ˆ | âœ… UserProfile | éœ€è¦ | å¤ç”¨ |
| **AIå¯¹è¯** | âŒ æ—  | â­ æ ¸å¿ƒ | **æ–°å¢** |
| **Kçº¿å›¾** | âŒ æ—  | â­ æ ¸å¿ƒ | **æ–°å¢** |
| **åˆå©š** | âŒ æ—  | éœ€è¦ | **æ–°å¢** |
| **ä»Šæ—¥è¿åŠ¿** | âŒ æ—  | éœ€è¦ | **æ–°å¢** |

---

## ğŸ—ï¸ èåˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (React + HTMX)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é¦–é¡µ    â”‚ â”‚ AIå¯¹è¯  â”‚ â”‚ Kçº¿å›¾   â”‚ â”‚ åˆå©š    â”‚ â”‚ åŸæœ‰  â”‚ â”‚
â”‚  â”‚ (æ–°)    â”‚ â”‚ (æ–°)    â”‚ â”‚ (æ–°)    â”‚ â”‚ (æ–°)    â”‚ â”‚ é¡µé¢  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚     ChatWidget (å…¨å±€ç»„ä»¶)      â”‚ â† æ¯ä¸ªé¡µé¢éƒ½æœ‰   â”‚
â”‚         â”‚     åº•éƒ¨å¯¹è¯å…¥å£               â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯ (Django)                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ–°å¢æ¨¡å— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                                                â”‚         â”‚
â”‚  â”‚  chat/                    # AIå¯¹è¯æ¨¡å—         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ views.py            # WebSocket/API      â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ services/                                â”‚         â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ai_service.py   # LLMè°ƒç”¨           â”‚         â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ tool_service.py # å·¥å…·è°ƒç”¨          â”‚         â”‚
â”‚  â”‚  â”‚   â””â”€â”€ context_service.py # ä¸Šä¸‹æ–‡ç®¡ç†     â”‚         â”‚
â”‚  â”‚  â””â”€â”€ models.py           # å¯¹è¯å†å²          â”‚         â”‚
â”‚  â”‚                                                â”‚         â”‚
â”‚  â”‚  kline/                   # Kçº¿æ¨¡å—           â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ views.py                                 â”‚         â”‚
â”‚  â”‚  â””â”€â”€ services/                                â”‚         â”‚
â”‚  â”‚      â””â”€â”€ kline_service.py # Kçº¿æ•°æ®ç”Ÿæˆ      â”‚         â”‚
â”‚  â”‚                                                â”‚         â”‚
â”‚  â”‚  match/                   # åˆå©šæ¨¡å—          â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ views.py                                 â”‚         â”‚
â”‚  â”‚  â””â”€â”€ services/                                â”‚         â”‚
â”‚  â”‚      â””â”€â”€ match_service.py # é…å¯¹åˆ†æ         â”‚         â”‚
â”‚  â”‚                                                â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                             â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¤ç”¨ç°æœ‰æ¨¡å— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â”‚  bazi/domain/services/                        â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ BaziAnalysisService    â† AIå·¥å…·è°ƒç”¨     â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ WuxingCalculator       â† AIå·¥å…·è°ƒç”¨     â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ ShishenCalculator      â† AIå·¥å…·è°ƒç”¨     â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ LiunianAnalysisService â† AIå·¥å…·è°ƒç”¨     â”‚          â”‚
â”‚  â”‚  â””â”€â”€ DayQualityService      â† AIå·¥å…·è°ƒç”¨     â”‚          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶ç»“æ„

```
fengshui/
â”œâ”€â”€ bazi/
â”‚   â”œâ”€â”€ ... (ä¿æŒä¸å˜)
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                          # ğŸ†• AIå¯¹è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py                  # å¯¹è¯å†å²æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ views.py                   # APIè§†å›¾
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ consumers.py               # WebSocket (å¯é€‰)
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ ai_service.py          # LLMæœåŠ¡
â”‚   â”‚       â”œâ”€â”€ tool_registry.py       # å·¥å…·æ³¨å†Œ
â”‚   â”‚       â””â”€â”€ tools/
â”‚   â”‚           â”œâ”€â”€ __init__.py
â”‚   â”‚           â”œâ”€â”€ bazi_tool.py       # å…«å­—åˆ†æå·¥å…·
â”‚   â”‚           â”œâ”€â”€ fortune_tool.py    # è¿åŠ¿åˆ†æå·¥å…·
â”‚   â”‚           â”œâ”€â”€ kline_tool.py      # Kçº¿ç”Ÿæˆå·¥å…·
â”‚   â”‚           â””â”€â”€ match_tool.py      # åˆå©šåˆ†æå·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ kline/                         # ğŸ†• Kçº¿æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ kline_calculator.py    # Kçº¿æ•°æ®è®¡ç®—
â”‚   â”‚
â”‚   â””â”€â”€ match/                         # ğŸ†• åˆå©šæ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ views.py
â”‚       â”œâ”€â”€ urls.py
â”‚       â””â”€â”€ services/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ match_calculator.py    # é…å¯¹è®¡ç®—
â”‚
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ ... (ä¿æŒä¸å˜)
â”‚       â”‚
â”‚       â”œâ”€â”€ components/                # ğŸ†• æ–°ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ ChatWidget/            # å…¨å±€å¯¹è¯ç»„ä»¶
â”‚       â”‚   â”‚   â”œâ”€â”€ ChatWidget.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx
â”‚       â”‚   â”‚   â””â”€â”€ ChartCard.tsx
â”‚       â”‚   â”œâ”€â”€ KLineChart/            # Kçº¿å›¾ç»„ä»¶
â”‚       â”‚   â”‚   â””â”€â”€ KLineChart.tsx
â”‚       â”‚   â””â”€â”€ MatchCard/             # åˆå©šç»“æœç»„ä»¶
â”‚       â”‚       â””â”€â”€ MatchCard.tsx
â”‚       â”‚
â”‚       â””â”€â”€ pages/                     # ğŸ†• æ–°é¡µé¢
â”‚           â”œâ”€â”€ HomePage.tsx           # æ–°é¦–é¡µ
â”‚           â”œâ”€â”€ ChatPage.tsx           # å…¨å±å¯¹è¯
â”‚           â”œâ”€â”€ KLinePage.tsx          # Kçº¿è¯¦æƒ…
â”‚           â””â”€â”€ MatchPage.tsx          # åˆå©šé¡µé¢
â”‚
â””â”€â”€ templates/
    â”œâ”€â”€ ... (ä¿æŒä¸å˜)
    â”‚
    â”œâ”€â”€ home_new.html                  # ğŸ†• æ–°é¦–é¡µæ¨¡æ¿
    â”œâ”€â”€ chat.html                      # ğŸ†• å¯¹è¯é¡µé¢æ¨¡æ¿
    â”œâ”€â”€ kline.html                     # ğŸ†• Kçº¿é¡µé¢æ¨¡æ¿
    â””â”€â”€ match.html                     # ğŸ†• åˆå©šé¡µé¢æ¨¡æ¿
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°æ–¹æ¡ˆ

### 1. AIå¯¹è¯æœåŠ¡ (chat/services/ai_service.py)

```python
from anthropic import Anthropic
from typing import Generator
import json

class AIService:
    """AIå¯¹è¯æœåŠ¡ - è°ƒç”¨Claude API"""

    def __init__(self):
        self.client = Anthropic()
        self.tools = self._register_tools()

    def _register_tools(self):
        """æ³¨å†ŒAIå¯è°ƒç”¨çš„å·¥å…·"""
        return [
            {
                "name": "analyze_bazi",
                "description": "åˆ†æç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼ŒåŒ…æ‹¬å››æŸ±ã€äº”è¡Œã€åç¥ç­‰",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "birth_year": {"type": "integer"},
                        "birth_month": {"type": "integer"},
                        "birth_day": {"type": "integer"},
                        "birth_hour": {"type": "integer"},
                        "is_male": {"type": "boolean"}
                    },
                    "required": ["birth_year", "birth_month", "birth_day", "birth_hour"]
                }
            },
            {
                "name": "generate_kline",
                "description": "ç”Ÿæˆç”¨æˆ·çš„äººç”ŸKçº¿å›¾æ•°æ®",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "profile_id": {"type": "integer"}
                    },
                    "required": ["profile_id"]
                }
            },
            {
                "name": "analyze_fortune",
                "description": "åˆ†æç‰¹å®šæ—¶é—´æ®µçš„è¿åŠ¿",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "profile_id": {"type": "integer"},
                        "year": {"type": "integer"},
                        "month": {"type": "integer", "description": "å¯é€‰ï¼Œä¸ä¼ åˆ™åˆ†æå…¨å¹´"}
                    },
                    "required": ["profile_id", "year"]
                }
            },
            {
                "name": "match_compatibility",
                "description": "åˆ†æä¸¤ä¸ªäººçš„å…«å­—é…å¯¹",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "profile_id_1": {"type": "integer"},
                        "profile_id_2": {"type": "integer"}
                    },
                    "required": ["profile_id_1", "profile_id_2"]
                }
            }
        ]

    def chat(self, messages: list, profile_id: int = None) -> Generator:
        """
        ä¸AIå¯¹è¯ï¼Œæ”¯æŒæµå¼è¾“å‡º

        Args:
            messages: å¯¹è¯å†å²
            profile_id: å½“å‰ç”¨æˆ·æ¡£æ¡ˆID

        Yields:
            AIå›å¤çš„ç‰‡æ®µ
        """
        system_prompt = self._build_system_prompt(profile_id)

        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=4096,
            system=system_prompt,
            tools=self.tools,
            messages=messages,
            stream=True
        )

        for event in response:
            if event.type == "content_block_delta":
                yield event.delta
            elif event.type == "tool_use":
                # å¤„ç†å·¥å…·è°ƒç”¨
                tool_result = self._execute_tool(event.name, event.input)
                yield {"type": "tool_result", "data": tool_result}

    def _build_system_prompt(self, profile_id: int = None) -> str:
        """æ„å»ºç³»ç»Ÿæç¤ºè¯"""
        base_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘½ç†AIåŠ©æ‰‹ï¼Œç²¾é€šå…«å­—ã€äº”è¡Œã€åç¥ç­‰ä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå‘½ç†çŸ¥è¯†ï¼Œé¿å…è¿‡å¤šä¸“ä¸šæœ¯è¯­
2. ç»“åˆç”¨æˆ·çš„å…·ä½“æƒ…å†µç»™å‡ºä¸ªæ€§åŒ–å»ºè®®
3. å›ç­”æ—¶æ—¢è¦æœ‰ä¼ ç»Ÿå‘½ç†çš„ä¾æ®ï¼Œä¹Ÿè¦å®ç”¨å¯è¡Œ
4. é€‚æ—¶ä½¿ç”¨å¯è§†åŒ–ï¼ˆå¦‚Kçº¿å›¾ï¼‰å¸®åŠ©ç”¨æˆ·ç†è§£

å½“ç”¨æˆ·è¯¢é—®è¿åŠ¿ç›¸å…³é—®é¢˜æ—¶ï¼š
- å¦‚æœéœ€è¦åˆ†æå…«å­—ï¼Œè°ƒç”¨ analyze_bazi å·¥å…·
- å¦‚æœéœ€è¦å±•ç¤ºäººç”Ÿè¿åŠ¿èµ°å‘ï¼Œè°ƒç”¨ generate_kline å·¥å…·
- å¦‚æœéœ€è¦åˆ†æç‰¹å®šæ—¶é—´è¿åŠ¿ï¼Œè°ƒç”¨ analyze_fortune å·¥å…·
- å¦‚æœéœ€è¦é…å¯¹åˆ†æï¼Œè°ƒç”¨ match_compatibility å·¥å…·

å›å¤æ ¼å¼å»ºè®®ï¼š
- å…ˆç»™å‡ºæ ¸å¿ƒç»“è®º
- å†è§£é‡Šä¾æ®
- æœ€åç»™å‡ºå»ºè®®
- å¦‚æœ‰å›¾è¡¨ï¼Œåœ¨é€‚å½“ä½ç½®åµŒå…¥
"""

        if profile_id:
            # åŠ è½½ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯ä½œä¸ºä¸Šä¸‹æ–‡
            base_prompt += f"\n\nç”¨æˆ·å·²æœ‰æ¡£æ¡ˆID: {profile_id}"

        return base_prompt

    def _execute_tool(self, tool_name: str, tool_input: dict) -> dict:
        """æ‰§è¡Œå·¥å…·è°ƒç”¨"""
        from .tools import bazi_tool, fortune_tool, kline_tool, match_tool

        tool_map = {
            "analyze_bazi": bazi_tool.analyze,
            "generate_kline": kline_tool.generate,
            "analyze_fortune": fortune_tool.analyze,
            "match_compatibility": match_tool.analyze
        }

        if tool_name in tool_map:
            return tool_map[tool_name](**tool_input)

        return {"error": f"Unknown tool: {tool_name}"}
```

### 2. Kçº¿è®¡ç®—æœåŠ¡ (kline/services/kline_calculator.py)

```python
from bazi.domain.services import BaziAnalysisService, LiunianAnalysisService
from bazi.infrastructure.di.container import get_container
from typing import List, Dict

class KLineCalculator:
    """äººç”ŸKçº¿å›¾è®¡ç®—å™¨"""

    def __init__(self):
        container = get_container()
        self.bazi_service = container.bazi_analysis_service
        self.liunian_service = container.liunian_analysis_service

    def calculate(self, profile) -> Dict:
        """
        è®¡ç®—å®Œæ•´çš„äººç”ŸKçº¿æ•°æ®

        Returns:
            {
                "data_points": [
                    {"age": 20, "score": 65, "phase": "ç§¯ç´¯æœŸ", "description": "..."},
                    {"age": 25, "score": 70, "phase": "ç§¯ç´¯æœŸ", "description": "..."},
                    ...
                ],
                "current_age": 34,
                "current_phase": {
                    "name": "ä¸Šå‡æœŸ",
                    "range": [34, 44],
                    "keywords": ["äº‹ä¸šçªç ´", "è´µäººåŠ©åŠ›"],
                    "description": "è¿™æ˜¯ä½ äººç”Ÿä¸­æœ€é‡è¦çš„é»„é‡‘åå¹´..."
                },
                "phases": [
                    {"range": [20, 30], "name": "ç§¯ç´¯æœŸ", "trend": "up"},
                    {"range": [30, 40], "name": "ä¸Šå‡æœŸ", "trend": "up"},
                    ...
                ]
            }
        """
        # 1. è·å–å…«å­—
        bazi = self.bazi_service.analyze(
            profile.birth_year,
            profile.birth_month,
            profile.birth_day,
            profile.birth_hour,
            profile.is_male
        )

        # 2. è®¡ç®—å„å¹´é¾„æ®µè¿åŠ¿
        data_points = []
        current_year = 2024
        birth_year = profile.birth_year

        for age in range(20, 81, 5):
            target_year = birth_year + age

            # ä½¿ç”¨æµå¹´æœåŠ¡è®¡ç®—è¯¥å¹´è¿åŠ¿
            liunian = self.liunian_service.analyze(bazi, target_year)

            # è®¡ç®—ç»¼åˆè¯„åˆ†
            score = self._calculate_score(bazi, liunian)

            data_points.append({
                "age": age,
                "year": target_year,
                "score": score,
                "phase": self._get_phase_name(score, age),
                "description": self._generate_description(bazi, liunian, age)
            })

        # 3. è¯†åˆ«äººç”Ÿé˜¶æ®µ
        phases = self._identify_phases(data_points)

        # 4. ç¡®å®šå½“å‰é˜¶æ®µ
        current_age = current_year - birth_year
        current_phase = self._get_current_phase(phases, current_age)

        return {
            "data_points": data_points,
            "current_age": current_age,
            "current_phase": current_phase,
            "phases": phases
        }

    def _calculate_score(self, bazi, liunian) -> int:
        """è®¡ç®—è¿åŠ¿è¯„åˆ† (0-100)"""
        # åŸºäºäº”è¡Œå¹³è¡¡ã€åç¥é…ç½®ã€æµå¹´é…åˆç­‰è®¡ç®—
        base_score = 60

        # 1. æ—¥ä¸»å¼ºå¼±å½±å“
        if bazi.is_day_master_strong:
            base_score += 5

        # 2. äº”è¡Œå¹³è¡¡å½±å“
        wuxing_balance = self._calc_wuxing_balance(bazi)
        base_score += wuxing_balance * 10

        # 3. æµå¹´é…åˆå½±å“
        liunian_factor = self._calc_liunian_factor(bazi, liunian)
        base_score += liunian_factor * 15

        return min(100, max(0, int(base_score)))

    def _identify_phases(self, data_points: List[Dict]) -> List[Dict]:
        """è¯†åˆ«äººç”Ÿé˜¶æ®µ"""
        phases = []
        # æ ¹æ®åˆ†æ•°èµ°åŠ¿åˆ’åˆ†é˜¶æ®µ
        # ... å®ç°é˜¶æ®µè¯†åˆ«é€»è¾‘
        return phases

    def _get_current_phase(self, phases: List[Dict], current_age: int) -> Dict:
        """è·å–å½“å‰æ‰€å¤„é˜¶æ®µ"""
        for phase in phases:
            if phase["range"][0] <= current_age <= phase["range"][1]:
                return phase
        return phases[-1] if phases else None
```

### 3. å‰ç«¯å¯¹è¯ç»„ä»¶ (frontend/src/components/ChatWidget/ChatWidget.tsx)

```typescript
import React, { useState, useRef, useEffect } from 'react';
import { MessageBubble } from './MessageBubble';
import { ChatInput } from './ChatInput';
import { ChartCard } from './ChartCard';

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  attachments?: Attachment[];
}

interface Attachment {
  type: 'chart' | 'quickActions';
  data: any;
}

export const ChatWidget: React.FC = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [isFullScreen, setIsFullScreen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const sendMessage = async (content: string) => {
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content
    };
    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);

    try {
      // è°ƒç”¨åç«¯API
      const response = await fetch('/api/chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
          messages: [...messages, userMessage].map(m => ({
            role: m.role,
            content: m.content
          }))
        })
      });

      const data = await response.json();

      // æ·»åŠ AIå›å¤
      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: data.content,
        attachments: data.attachments
      };
      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('Chat error:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // æ”¶èµ·çŠ¶æ€ - æ˜¾ç¤ºåœ¨é¡µé¢åº•éƒ¨
  if (!isOpen) {
    return (
      <div
        className="fixed bottom-4 left-4 right-4 z-50"
        onClick={() => { setIsOpen(true); setIsFullScreen(true); }}
      >
        <div className="bg-base-200 rounded-full px-4 py-3 flex items-center gap-2 cursor-pointer hover:bg-base-300 transition shadow-lg">
          <span className="text-xl">ğŸ’¬</span>
          <span className="text-base-content/60 flex-1">æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿç‚¹å‡»å’Œæˆ‘èŠèŠ...</span>
          <span className="text-xl">ğŸ¤</span>
        </div>
      </div>
    );
  }

  // å…¨å±å¯¹è¯æ¨¡å¼
  return (
    <div className={`fixed inset-0 z-50 bg-base-100 flex flex-col ${isFullScreen ? '' : 'hidden'}`}>
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b border-base-300">
        <button
          className="btn btn-ghost btn-circle"
          onClick={() => { setIsOpen(false); setIsFullScreen(false); }}
        >
          â†
        </button>
        <h2 className="text-lg font-bold">AIå‘½ç†åŠ©æ‰‹</h2>
        <div className="w-10"></div>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.length === 0 && (
          <MessageBubble
            role="assistant"
            content="ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å‘½ç†AIåŠ©æ‰‹ âœ¨ æˆ‘å¯ä»¥å¸®ä½ äº†è§£äº‹ä¸šè´¢è¿ã€æ„Ÿæƒ…å©šå§»ã€å¥åº·è¿åŠ¿ç­‰ã€‚ä½ ç°åœ¨æœ€æƒ³äº†è§£å“ªæ–¹é¢ï¼Ÿ"
          />
        )}

        {messages.map(msg => (
          <React.Fragment key={msg.id}>
            <MessageBubble role={msg.role} content={msg.content} />
            {msg.attachments?.map((att, i) => (
              att.type === 'chart' ? (
                <ChartCard key={i} {...att.data} />
              ) : null
            ))}
          </React.Fragment>
        ))}

        {isLoading && (
          <div className="flex gap-1 p-3">
            <span className="loading loading-dots loading-sm"></span>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Input */}
      <ChatInput onSend={sendMessage} disabled={isLoading} />
    </div>
  );
};

function getCsrfToken(): string {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
```

---

## ğŸ—ºï¸ URLè·¯ç”±è§„åˆ’

```python
# fengshui/urls.py æ–°å¢è·¯ç”±

urlpatterns = [
    # ... ä¿ç•™ç°æœ‰è·¯ç”±

    # ğŸ†• æ–°å¢è·¯ç”±
    path('', views.home_new, name='home_new'),           # æ–°é¦–é¡µ
    path('chat/', views.chat_view, name='chat'),          # å¯¹è¯é¡µé¢
    path('api/chat/', views.chat_api, name='chat_api'),   # å¯¹è¯API
    path('kline/', views.kline_view, name='kline'),       # Kçº¿é¡µé¢
    path('api/kline/', views.kline_api, name='kline_api'),# Kçº¿API
    path('match/', views.match_view, name='match'),       # åˆå©šé¡µé¢
    path('api/match/', views.match_api, name='match_api'),# åˆå©šAPI
]
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€å¯¹è¯åŠŸèƒ½ (1-2å‘¨)

| ä»»åŠ¡ | è¯´æ˜ |
|-----|------|
| åˆ›å»º chat æ¨¡å— | æ¨¡å‹ã€è§†å›¾ã€è·¯ç”± |
| å®ç° AIService | å¯¹æ¥ Claude API |
| å®ç°åŸºç¡€å·¥å…· | bazi_tool, fortune_tool |
| åˆ›å»º ChatWidget | å‰ç«¯å¯¹è¯ç»„ä»¶ |
| é›†æˆåˆ°ç°æœ‰é¡µé¢ | æ¯ä¸ªé¡µé¢æ·»åŠ å¯¹è¯å…¥å£ |

### Phase 2: Kçº¿å¯è§†åŒ– (1å‘¨)

| ä»»åŠ¡ | è¯´æ˜ |
|-----|------|
| åˆ›å»º kline æ¨¡å— | è®¡ç®—æœåŠ¡ |
| å®ç° KLineChart | ä½¿ç”¨ Chart.js/ECharts |
| Kçº¿é¡µé¢ | å®Œæ•´çš„Kçº¿è¯¦æƒ…é¡µ |
| AIå·¥å…·é›†æˆ | generate_kline å·¥å…· |

### Phase 3: åˆå©šåŠŸèƒ½ (1å‘¨)

| ä»»åŠ¡ | è¯´æ˜ |
|-----|------|
| åˆ›å»º match æ¨¡å— | é…å¯¹è®¡ç®—æœåŠ¡ |
| åˆå©šé¡µé¢ | è¾“å…¥ + ç»“æœå±•ç¤º |
| AIå·¥å…·é›†æˆ | match_compatibility å·¥å…· |

### Phase 4: æ–°é¦–é¡µ + ä¼˜åŒ– (1å‘¨)

| ä»»åŠ¡ | è¯´æ˜ |
|-----|------|
| æ–°é¦–é¡µè®¾è®¡ | ä»Šæ—¥è¿åŠ¿ + å¿«æ·å…¥å£ |
| æ€§èƒ½ä¼˜åŒ– | ç¼“å­˜ã€æ‡’åŠ è½½ |
| æµ‹è¯• | ç«¯åˆ°ç«¯æµ‹è¯• |

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. å¤ç”¨ç°æœ‰æœåŠ¡

```python
# åœ¨ AI å·¥å…·ä¸­å¤ç”¨ç°æœ‰æœåŠ¡
from bazi.infrastructure.di.container import get_container

def analyze_bazi(**kwargs):
    container = get_container()
    service = container.bazi_analysis_service

    result = service.analyze(
        kwargs['birth_year'],
        kwargs['birth_month'],
        kwargs['birth_day'],
        kwargs['birth_hour'],
        kwargs.get('is_male', True)
    )

    # è½¬æ¢ä¸ºAIå‹å¥½çš„æ ¼å¼
    return {
        "bazi": str(result.bazi),
        "day_master": result.day_master,
        "wuxing_strength": result.wuxing_strength,
        "shishen": result.shishen,
        # ...
    }
```

### 2. å¯¹è¯å†å²å­˜å‚¨

```python
# chat/models.py
from django.db import models
from django.contrib.auth.models import User

class Conversation(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class Message(models.Model):
    conversation = models.ForeignKey(Conversation, on_delete=models.CASCADE)
    role = models.CharField(max_length=20)  # user / assistant
    content = models.TextField()
    attachments = models.JSONField(default=list)
    created_at = models.DateTimeField(auto_now_add=True)
```

### 3. ä¿æŒç°æœ‰é¡µé¢ä¸å˜

æ–°åŠŸèƒ½é€šè¿‡**å¢é‡æ–¹å¼**æ·»åŠ ï¼š
- ç°æœ‰é¡µé¢ä¿æŒä¸å˜ï¼Œåªæ·»åŠ åº•éƒ¨å¯¹è¯å…¥å£
- æ–°é¦–é¡µä½œä¸ºå¯é€‰é¡¹ï¼Œå¯é€šè¿‡é…ç½®åˆ‡æ¢
- æ¸è¿›å¼è¿ç§»ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·

---

## âœ… ä¸‹ä¸€æ­¥

1. ç¡®è®¤æ–¹æ¡ˆåï¼Œæˆ‘å¯ä»¥å¼€å§‹åˆ›å»ºä»£ç æ–‡ä»¶
2. ä¼˜å…ˆå®ç° AI å¯¹è¯æ¨¡å—ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
3. é€æ­¥æ·»åŠ  Kçº¿ã€åˆå©šç­‰åŠŸèƒ½

éœ€è¦æˆ‘å¼€å§‹å®ç°å“ªä¸ªéƒ¨åˆ†ï¼Ÿ

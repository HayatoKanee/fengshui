{% extends 'base_content.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mx-auto px-4 py-6"
     x-data="{
         formExpanded: {% if bazi %}false{% else %}true{% endif %},
         showSaveInput: false,
         saveName: '',
         currentProfile: null,
         saving: false,
         saved: false,
         profileSheetOpen: false,
         formData: {
             year: '{{ form.year.value|default:"" }}',
             month: '{{ form.month.value|default:"" }}',
             day: '{{ form.day.value|default:"" }}',
             hour: '{{ form.hour.value|default:"" }}',
             minute: '{{ form.minute.value|default:"0" }}',
             gender: '{{ form.gender.value|default:"male" }}'
         },
         get hasResults() { return {% if bazi %}true{% else %}false{% endif %}; },
         get hourName() {
             const hours = ['子', '丑', '丑', '寅', '寅', '卯', '卯', '辰', '辰', '巳', '巳', '午', '午', '未', '未', '申', '申', '酉', '酉', '戌', '戌', '亥', '亥', '子'];
             const h = parseInt(this.formData.hour) || 0;
             return hours[h] + '时';
         },
         init() {
             // Restore currentProfile from sessionStorage after page reload
             const savedProfileId = sessionStorage.getItem('currentBaziProfileId');
             if (savedProfileId && this.hasResults) {
                 const store = Alpine.store('profiles');
                 if (store && store.profiles) {
                     const profile = store.profiles.find(p => String(p.id) === savedProfileId || String(p.localId) === savedProfileId);
                     if (profile) {
                         this.currentProfile = profile;
                         this.saved = true;
                     }
                 }
             }
         },
         loadProfile(profile) {
             this.formData.year = String(profile.birth_year);
             this.formData.month = String(profile.birth_month);
             this.formData.day = String(profile.birth_day);
             this.formData.hour = String(profile.birth_hour);
             this.formData.minute = String(profile.birth_minute || 0);
             this.formData.gender = (profile.is_male === true || profile.is_male === 1) ? 'male' : 'female';
             this.currentProfile = profile;
             this.saved = true;
             // Persist to sessionStorage so it survives page reload
             sessionStorage.setItem('currentBaziProfileId', String(profile.id || profile.localId));
             this.formExpanded = false;
             this.$nextTick(() => { this.$refs.baziForm.submit(); });
         },
         clearCurrentProfile(clearForm = false) {
             this.currentProfile = null;
             this.saved = false;
             sessionStorage.removeItem('currentBaziProfileId');
             if (clearForm) {
                 this.formData = { year: '', month: '', day: '', hour: '', minute: '0', gender: 'male' };
             }
         },
         async saveProfile() {
             if (this.saving || !this.saveName.trim()) return;
             this.saving = true;
             try {
                 const profileData = {
                     name: this.saveName.trim(),
                     birth_year: parseInt(this.formData.year),
                     birth_month: parseInt(this.formData.month),
                     birth_day: parseInt(this.formData.day),
                     birth_hour: parseInt(this.formData.hour),
                     birth_minute: parseInt(this.formData.minute) || 0,
                     is_male: this.formData.gender === 'male'
                 };
                 const store = Alpine.store('profiles');
                 const newProfile = await store.createProfile(profileData);
                 this.currentProfile = newProfile;
                 this.saved = true;
                 this.showSaveInput = false;
                 this.saveName = '';
                 sessionStorage.setItem('currentBaziProfileId', String(newProfile.id || newProfile.localId));
                 Alpine.store('toast')?.show('success', '已保存');
             } catch (e) {
                 console.error('Save failed:', e);
                 Alpine.store('toast')?.show('error', '保存失败');
             } finally {
                 this.saving = false;
             }
         },
         async updateAndSubmit() {
             if (this.saving || !this.currentProfile) return;
             this.saving = true;
             try {
                 const profileData = {
                     birth_year: parseInt(this.formData.year),
                     birth_month: parseInt(this.formData.month),
                     birth_day: parseInt(this.formData.day),
                     birth_hour: parseInt(this.formData.hour),
                     birth_minute: parseInt(this.formData.minute) || 0,
                     is_male: this.formData.gender === 'male'
                 };
                 const store = Alpine.store('profiles');
                 await store.updateProfile(this.currentProfile.id, profileData);
                 // Refresh currentProfile with updated data
                 this.currentProfile = { ...this.currentProfile, ...profileData };
                 // Now submit the form to show results
                 this.$refs.baziForm.submit();
             } catch (e) {
                 console.error('Update failed:', e);
                 Alpine.store('toast')?.show('error', '更新失败');
                 this.saving = false;
             }
         },
         deleteProfile(profile) {
             if (!profile) return;
             if (confirm('确定要删除「' + (profile.name || '未命名') + '」吗？')) {
                 Alpine.store('profiles').deleteProfile(profile.id);
                 // If deleted profile was current, clear it
                 if (this.currentProfile && this.currentProfile.id === profile.id) {
                     this.clearCurrentProfile(false);  // Keep form data so user can save as new
                 }
             }
         }
     }">

    {% if bazi %}
    <!-- COLLAPSED STATE: Summary bar when results are shown -->
    <!-- Pre-rendered with Django for instant display, no FOUC -->
    <div x-show="!formExpanded" x-transition class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body py-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <!-- Left: Profile info - Pre-rendered from Django -->
                <div class="flex items-center gap-2">
                    <!-- Profile name (only shows after Alpine loads) -->
                    <span x-show="currentProfile" x-cloak class="text-lg font-medium" x-text="currentProfile?.name"></span>
                    <span x-show="currentProfile" x-cloak class="text-base-content/60">·</span>
                    <!-- Date info - Pre-rendered from Django (instant, no flash) -->
                    <span class="text-base-content/60">{{ form.year.value }}.{{ form.month.value }}.{{ form.day.value }} {{ bazi.getTimeZhi }}时</span>
                    <span class="text-base-content/60">{% if form.gender.value == 'male' %}男{% else %}女{% endif %}</span>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-2">
                    <!-- Profile switcher (if has saved profiles) -->
                    <template x-if="$store.profiles && $store.profiles.profiles && $store.profiles.profiles.length > 0">
                        <div>
                            <!-- Mobile: Button to open bottom sheet -->
                            <button type="button" @click="profileSheetOpen = true" class="btn btn-sm btn-ghost gap-1 md:hidden">
                                切换
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <!-- Desktop: Traditional dropdown -->
                            <details class="dropdown dropdown-end hidden md:block">
                                <summary class="btn btn-sm btn-ghost gap-1">
                                    切换
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </summary>
                                <ul class="dropdown-content z-[100] menu p-2 shadow-lg bg-base-100 rounded-box w-72 max-h-64 overflow-y-auto border border-base-300">
                                    <template x-for="profile in $store.profiles.profiles" :key="profile.id || profile.localId">
                                        <li>
                                            <div class="relative w-full" :class="{ 'active': currentProfile && currentProfile.id === profile.id }">
                                                <button type="button" @click="loadProfile(profile); $el.closest('details').removeAttribute('open');"
                                                        class="flex flex-col items-start gap-0.5 w-full text-left pr-6">
                                                    <span class="font-medium" x-text="profile.name || '未命名'"></span>
                                                    <span class="text-xs opacity-50" x-text="profile.birth_year + '年' + profile.birth_month + '月' + profile.birth_day + '日'"></span>
                                                </button>
                                                <button type="button" @click.stop="deleteProfile(profile)"
                                                        class="absolute top-1 right-1 p-0.5 rounded opacity-40 hover:opacity-100 hover:text-error transition-all">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </li>
                                    </template>
                                    <li class="border-t border-base-200 mt-1 pt-1">
                                        <a href="{% url 'bazi' %}" @click="clearCurrentProfile(true)" class="text-primary">
                                            + 新排盘
                                        </a>
                                    </li>
                                </ul>
                            </details>
                        </div>
                    </template>

                    <!-- Save button (only if unsaved) -->
                    <template x-if="!currentProfile && !showSaveInput">
                        <button type="button" @click="showSaveInput = true; saveName = ''" class="btn btn-sm btn-primary">
                            保存
                        </button>
                    </template>

                    <!-- Inline save input -->
                    <template x-if="showSaveInput">
                        <div class="flex items-center gap-2">
                            <input type="text" x-model="saveName" placeholder="输入名称"
                                   class="input input-sm input-bordered w-32"
                                   @keydown.enter.prevent="saveProfile()"
                                   @keydown.escape="showSaveInput = false">
                            <button type="button" @click="saveProfile()" :disabled="saving || !saveName.trim()" class="btn btn-sm btn-primary">
                                <span x-show="saving" class="loading loading-spinner loading-xs"></span>
                                <span x-show="!saving">确定</span>
                            </button>
                            <button type="button" @click="showSaveInput = false" class="btn btn-sm btn-ghost">取消</button>
                        </div>
                    </template>

                    <!-- Edit button -->
                    <button type="button" @click="formExpanded = true" class="btn btn-sm btn-ghost">
                        修改
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- EXPANDED STATE: Full form -->
    <!-- When bazi exists: hidden by default (x-cloak), shown when user clicks "修改" -->
    <!-- When no bazi: shown immediately (no x-cloak) -->
    <div {% if bazi %}x-cloak{% endif %} x-show="formExpanded || !hasResults" x-transition class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <div class="flex justify-between items-center mb-2">
                <div class="flex flex-col gap-1">
                    <h3 class="card-title text-xl">输入八字资料</h3>
                    <!-- Editing indicator when modifying a saved profile -->
                    <template x-if="currentProfile">
                        <div class="flex items-center gap-2 text-sm text-base-content/70">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span>正在编辑: <span class="font-medium text-primary" x-text="currentProfile.name"></span></span>
                        </div>
                    </template>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Saved profiles dropdown (appears when profiles exist) -->
                    <template x-if="$store.profiles && $store.profiles.profiles && $store.profiles.profiles.length > 0">
                        <div>
                            <!-- Mobile: Button to open bottom sheet -->
                            <button type="button" @click="profileSheetOpen = true" class="btn btn-sm btn-outline btn-primary gap-1 md:hidden">
                                <template x-if="currentProfile">
                                    <span x-text="currentProfile.name || '未命名'"></span>
                                </template>
                                <template x-if="!currentProfile">
                                    <span>已保存 <span class="badge badge-primary badge-sm" x-text="$store.profiles.profiles.length"></span></span>
                                </template>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <!-- Desktop: Traditional dropdown -->
                            <details class="dropdown dropdown-end hidden md:block">
                                <summary class="btn btn-sm btn-outline btn-primary gap-1">
                                    <template x-if="currentProfile">
                                        <span x-text="currentProfile.name || '未命名'"></span>
                                    </template>
                                    <template x-if="!currentProfile">
                                        <span>已保存 <span class="badge badge-primary badge-sm" x-text="$store.profiles.profiles.length"></span></span>
                                    </template>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </summary>
                                <ul class="dropdown-content z-[100] menu p-2 shadow-lg bg-base-100 rounded-box w-72 max-h-64 overflow-y-auto border border-base-300">
                                    <template x-for="profile in $store.profiles.profiles" :key="profile.id || profile.localId">
                                        <li>
                                            <div class="relative w-full" :class="{ 'active': currentProfile && currentProfile.id === profile.id }">
                                                <button type="button" @click="loadProfile(profile); $el.closest('details').removeAttribute('open');"
                                                        class="flex flex-col items-start gap-0.5 w-full text-left pr-6">
                                                    <span class="font-medium" x-text="profile.name || '未命名'"></span>
                                                    <span class="text-xs opacity-50" x-text="profile.birth_year + '年' + profile.birth_month + '月' + profile.birth_day + '日'"></span>
                                                </button>
                                                <button type="button" @click.stop="deleteProfile(profile)"
                                                        class="absolute top-1 right-1 p-0.5 rounded opacity-40 hover:opacity-100 hover:text-error transition-all">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </li>
                                    </template>
                                    <li class="border-t border-base-200 mt-1 pt-1">
                                        <a href="{% url 'bazi' %}" @click="clearCurrentProfile(true)" class="text-primary">
                                            + 新建八字
                                        </a>
                                    </li>
                                </ul>
                            </details>
                        </div>
                    </template>
                    {% if bazi %}
                    <button type="button" @click="formExpanded = false" class="btn btn-sm btn-ghost" x-show="hasResults">
                        收起
                    </button>
                    {% endif %}
                </div>
            </div>

            <form x-ref="baziForm" action="{% url 'bazi' %}" method="post" class="space-y-4">
                {% csrf_token %}

                <!-- Birth Date Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label" for="id_year">
                            <span class="label-text">出生年</span>
                        </label>
                        <input type="number" name="year" id="id_year"
                               x-model="formData.year"
                               class="input input-bordered w-full"
                               value="{{ form.year.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_month">
                            <span class="label-text">出生月</span>
                        </label>
                        <input type="number" name="month" id="id_month"
                               x-model="formData.month"
                               class="input input-bordered w-full"
                               min="1" max="12"
                               value="{{ form.month.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_day">
                            <span class="label-text">出生日</span>
                        </label>
                        <input type="number" name="day" id="id_day"
                               x-model="formData.day"
                               class="input input-bordered w-full"
                               min="1" max="31"
                               value="{{ form.day.value|default:'' }}"
                               required>
                    </div>
                </div>

                <!-- Birth Time Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label" for="id_hour">
                            <span class="label-text">出生时</span>
                        </label>
                        <input type="number" name="hour" id="id_hour"
                               x-model="formData.hour"
                               class="input input-bordered w-full"
                               min="0" max="23"
                               value="{{ form.hour.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_minute">
                            <span class="label-text">出生分</span>
                        </label>
                        <input type="number" name="minute" id="id_minute"
                               x-model="formData.minute"
                               class="input input-bordered w-full"
                               min="0" max="59"
                               value="{{ form.minute.value|default:'0' }}">
                    </div>
                </div>

                <!-- Gender Selection -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">性别</span>
                    </label>
                    <div class="flex gap-6">
                        <label class="label cursor-pointer gap-2">
                            <input type="radio" name="gender" value="male"
                                   x-model="formData.gender"
                                   class="radio radio-primary"
                                   {% if form.gender.value == 'male' or not form.gender.value %}checked{% endif %}>
                            <span class="label-text">男</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="radio" name="gender" value="female"
                                   x-model="formData.gender"
                                   class="radio radio-primary"
                                   {% if form.gender.value == 'female' %}checked{% endif %}>
                            <span class="label-text">女</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex flex-col gap-2">
                    <!-- When editing: show update+view button, when new: show just view -->
                    <template x-if="currentProfile">
                        <button type="button" @click="updateAndSubmit()" :disabled="saving" class="btn btn-primary w-full gap-2">
                            <span x-show="saving" class="loading loading-spinner loading-xs"></span>
                            更新及查看
                        </button>
                    </template>
                    <template x-if="!currentProfile">
                        <button type="submit" class="btn btn-primary w-full">
                            查看八字
                        </button>
                    </template>
                </div>
            </form>
        </div>
    </div>

    <!-- Bazi Results Display -->
    {% if bazi %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">八字排盘</h2>

            <!-- Main Bazi Table -->
            <div class="overflow-x-auto mb-6">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th></th>
                            <th class="text-center">时柱</th>
                            <th class="text-center">日柱</th>
                            <th class="text-center">月柱</th>
                            <th class="text-center">年柱</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>天干</th>
                            <td class="text-center text-lg font-semibold">{{ bazi.getTimeGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getDayGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getMonthGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getYearGan }}</td>
                        </tr>
                        <tr>
                            <th>地支</th>
                            <td class="text-center text-lg font-semibold">{{ bazi.getTimeZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getDayZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getMonthZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getYearZhi }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Tabs -->
            <div x-data="{ activeTab: 'details' }">
                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{ 'tab-active': activeTab === 'details' }" @click="activeTab = 'details'">
                        详细计算
                    </a>
                    <a class="tab" :class="{ 'tab-active': activeTab === 'analysis' }" @click="activeTab = 'analysis'">
                        八字分析
                    </a>
                </div>

                <!-- Details Tab -->
                <div x-show="activeTab === 'details'" x-transition>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Summary Tables -->
                        <div class="space-y-6">
                            <!-- Wangxiang Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">旺相</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>五行</th>
                                                <th>旺相</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for wx, wangxiang in wang_xiang.items %}
                                                <tr><td>{{ wx }}</td><td>{{ wangxiang }}</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Wuxing Value Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">五行值</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>五行</th>
                                                <th>值</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for wx, value in wuxing_value.items %}
                                                <tr><td>{{ wx }}</td><td>{{ value|floatformat:2 }}</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Sheng Hao Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">生耗值</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>值</th>
                                                <th>占比</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>生总值</td>
                                                <td>{{ sheng_hao.0|floatformat:2 }}</td>
                                                <td>{{ sheng_hao_percentage.0|floatformat:2 }}%</td>
                                            </tr>
                                            <tr>
                                                <td>耗总值</td>
                                                <td>{{ sheng_hao.1|floatformat:2 }}</td>
                                                <td>{{ sheng_hao_percentage.1|floatformat:2 }}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Pillar Details -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Year Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">年柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getYearGan zhi=bazi.getYearZhi gan_value=values.0.0 zhi_value=values.0.1 hidden_gans=hidden_gans.0 yinyang=yinyang.0 wuxing=wuxing.0 shishen=shishen.0 wx_value=wang_xiang_values.0 gl_value=gan_liang_values.0 %}
                                </div>
                            </div>

                            <!-- Month Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">月柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getMonthGan zhi=bazi.getMonthZhi gan_value=values.1.0 zhi_value=values.1.1 hidden_gans=hidden_gans.1 yinyang=yinyang.1 wuxing=wuxing.1 shishen=shishen.1 wx_value=wang_xiang_values.1 gl_value=gan_liang_values.1 %}
                                </div>
                            </div>

                            <!-- Day Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">日柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getDayGan zhi=bazi.getDayZhi gan_value=values.2.0 zhi_value=values.2.1 hidden_gans=hidden_gans.2 yinyang=yinyang.2 wuxing=wuxing.2 shishen=shishen.2 wx_value=wang_xiang_values.2 gl_value=gan_liang_values.2 %}
                                </div>
                            </div>

                            <!-- Hour Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">时柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getTimeGan zhi=bazi.getTimeZhi gan_value=values.3.0 zhi_value=values.3.1 hidden_gans=hidden_gans.3 yinyang=yinyang.3 wuxing=wuxing.3 shishen=shishen.3 wx_value=wang_xiang_values.3 gl_value=gan_liang_values.3 %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div x-show="activeTab === 'analysis'" x-transition>
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <ul class="space-y-4">
                                <li class="flex flex-wrap items-center gap-2">
                                    <span class="font-medium">主属性:</span>
                                    <span class="badge badge-lg badge-primary">{{ main_wuxing }}</span>
                                    <span class="badge badge-lg {% if sheng_hao.0 > sheng_hao.1 %}badge-success{% else %}badge-warning{% endif %}">
                                        {% if sheng_hao.0 > sheng_hao.1 %}身强{% else %}身弱{% endif %}
                                    </span>
                                </li>
                                <li>
                                    <span class="font-medium">生肖：</span>
                                    <span class="text-lg">{{ shengxiao }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">神煞：</span>
                                    <ul class="mt-2 ml-4 space-y-1">
                                        {% for name, desc in shensha_list %}
                                            <li>
                                                <span class="badge badge-outline mr-2">{{ name }}</span>
                                                <span class="text-base-content/80">{{ desc }}</span>
                                            </li>
                                        {% empty %}
                                            <li class="text-base-content/60">无显著神煞</li>
                                        {% endfor %}
                                    </ul>
                                </li>
                                <li>
                                    <span class="font-medium">配偶之性情：</span>
                                    <span>{{ partner_analyst }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">自身性格：</span>
                                    <span>{{ personality }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">流年分析：</span>
                                    <div id="liunian-section" class="mt-2 p-3 bg-base-300 rounded-lg">
                                        <!-- Year Dropdown for Liunian -->
                                        <div class="flex flex-wrap items-center gap-4 mb-3">
                                            <label class="flex items-center gap-2">
                                                <span class="text-sm font-medium">选择流年：</span>
                                                <select id="liunian_year_select"
                                                        name="liunian_year"
                                                        class="select select-sm select-bordered"
                                                        hx-get="{% url 'liunian_partial' %}"
                                                        hx-target="#liunian-content"
                                                        hx-trigger="change"
                                                        hx-include="this,#liunian-section [name='birth_year'],#liunian-section [name='birth_month'],#liunian-section [name='birth_day'],#liunian-section [name='birth_hour'],#liunian-section [name='birth_minute'],#liunian-section [name='is_male']">
                                                    {% for year, ganzhi in liunian_year_options %}
                                                        <option value="{{ year }}" {% if year == selected_liunian_year %}selected{% endif %}>
                                                            {{ year }} {{ ganzhi }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </label>
                                            <span class="loading loading-spinner loading-sm htmx-indicator"></span>
                                        </div>
                                        <!-- Hidden fields to pass birth data for HTMX -->
                                        <input type="hidden" name="birth_year" value="{{ form.year.value }}">
                                        <input type="hidden" name="birth_month" value="{{ form.month.value }}">
                                        <input type="hidden" name="birth_day" value="{{ form.day.value }}">
                                        <input type="hidden" name="birth_hour" value="{{ form.hour.value }}">
                                        <input type="hidden" name="birth_minute" value="{{ form.minute.value|default:0 }}">
                                        <input type="hidden" name="is_male" value="{{ is_male }}">

                                        <!-- Liunian Content (updated via HTMX) -->
                                        <div id="liunian-content">
                                            {% include 'partials/liunian_content.html' %}
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Mobile Bottom Sheet for Profile Selection -->
    <div x-cloak x-show="profileSheetOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-[200] md:hidden"
         @click.self="profileSheetOpen = false">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50"></div>

        <!-- Bottom Sheet -->
        <div x-show="profileSheetOpen"
             x-transition:enter="transition ease-out duration-300 transform-gpu"
             x-transition:enter-start="translate-y-full"
             x-transition:enter-end="translate-y-0"
             x-transition:leave="transition ease-in duration-200 transform-gpu"
             x-transition:leave-start="translate-y-0"
             x-transition:leave-end="translate-y-full"
             class="absolute bottom-0 left-0 right-0 bg-base-100 rounded-t-2xl shadow-2xl max-h-[70vh] flex flex-col will-change-transform">

            <!-- Handle bar -->
            <div class="flex justify-center pt-3 pb-2">
                <div class="w-10 h-1 bg-base-300 rounded-full"></div>
            </div>

            <!-- Header -->
            <div class="flex items-center justify-between px-4 pb-3 border-b border-base-200">
                <h3 class="text-lg font-semibold">已保存的八字</h3>
                <button type="button" @click="profileSheetOpen = false" class="btn btn-sm btn-ghost btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Profile List -->
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <template x-if="$store.profiles && $store.profiles.profiles">
                    <template x-for="profile in $store.profiles.profiles" :key="profile.id || profile.localId">
                        <div class="relative">
                            <button type="button"
                                    @click="
                                        profileSheetOpen = false;
                                        sessionStorage.setItem('currentBaziProfileId', String(profile.id || profile.localId));
                                        const gender = (profile.is_male === true || profile.is_male === 1) ? 'male' : 'female';
                                        window.location.href = '/bazi?year=' + profile.birth_year + '&month=' + profile.birth_month + '&day=' + profile.birth_day + '&hour=' + profile.birth_hour + '&minute=' + (profile.birth_minute || 0) + '&gender=' + gender;
                                    "
                                    class="w-full text-left p-4 rounded-xl border-2 transition-all"
                                    :class="currentProfile && currentProfile.id === profile.id ? 'border-primary bg-primary/5' : 'border-base-200 hover:border-base-300 active:bg-base-200'">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-base" x-text="profile.name || '未命名'"></div>
                                        <div class="text-sm text-base-content/60 mt-0.5" x-text="profile.birth_year + '年' + profile.birth_month + '月' + profile.birth_day + '日'"></div>
                                    </div>
                                    <template x-if="currentProfile && currentProfile.id === profile.id">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </template>
                                </div>
                            </button>
                            <!-- Delete button -->
                            <button type="button" @click.stop="deleteProfile(profile)"
                                    class="absolute top-2 right-2 p-1.5 rounded-lg opacity-40 hover:opacity-100 hover:text-error hover:bg-error/10 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </template>
                </template>
            </div>

            <!-- Footer action -->
            <div class="p-4 border-t border-base-200">
                <a href="{% url 'bazi' %}" @click="clearCurrentProfile(true); profileSheetOpen = false;"
                   class="btn btn-primary btn-block gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新建八字
                </a>
            </div>
        </div>
    </div>

</div>
{% endblock %}

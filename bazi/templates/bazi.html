{% extends 'base_content.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mx-auto px-4 py-6"
     x-data="{
         showInputForm: true,
         showSaveModal: false,
         saveName: '',
         formData: {
             year: '{{ form.year.value|default:"" }}',
             month: '{{ form.month.value|default:"" }}',
             day: '{{ form.day.value|default:"" }}',
             hour: '{{ form.hour.value|default:"" }}',
             minute: '{{ form.minute.value|default:"0" }}',
             gender: '{{ form.gender.value|default:"male" }}'
         }
     }">

    <!-- Saved Profiles Section - Only show after loading completes and has profiles -->
    <template x-if="!$store.profiles.loading && $store.profiles.profiles.length > 0">
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h3 class="card-title text-xl">选择已保存的资料</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <template x-for="profile in $store.profiles.profiles" :key="profile.id || profile.localId">
                        <div class="relative group">
                            <button type="button"
                                    @click="
                                        formData.year = profile.birth_year;
                                        formData.month = profile.birth_month;
                                        formData.day = profile.birth_day;
                                        formData.hour = profile.birth_hour;
                                        formData.minute = profile.birth_minute;
                                        formData.gender = profile.is_male ? 'male' : 'female';
                                        showInputForm = true;
                                    "
                                    class="btn btn-outline btn-primary w-full justify-start text-left truncate">
                                <span x-text="profile.name"></span>
                            </button>
                            <button type="button"
                                    @click.stop="
                                        if (confirm('确定要删除 ' + profile.name + ' 吗？')) {
                                            $store.profiles.deleteProfile(profile.id);
                                        }
                                    "
                                    class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-base-300 text-base-content/60 hover:bg-error hover:text-white opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center justify-center text-xs"
                                    title="删除">×</button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <!-- Birth Form -->
    <div x-show="showInputForm" x-transition class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h3 class="card-title text-xl">输入八字资料</h3>

            <form x-ref="baziForm" action="{% url 'bazi' %}" method="post" class="space-y-4">
                {% csrf_token %}

                <!-- Birth Date Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label" for="id_year">
                            <span class="label-text">出生年</span>
                        </label>
                        <input type="number" name="year" id="id_year"
                               x-model="formData.year"
                               class="input input-bordered w-full"
                               value="{{ form.year.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_month">
                            <span class="label-text">出生月</span>
                        </label>
                        <input type="number" name="month" id="id_month"
                               x-model="formData.month"
                               class="input input-bordered w-full"
                               min="1" max="12"
                               value="{{ form.month.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_day">
                            <span class="label-text">出生日</span>
                        </label>
                        <input type="number" name="day" id="id_day"
                               x-model="formData.day"
                               class="input input-bordered w-full"
                               min="1" max="31"
                               value="{{ form.day.value|default:'' }}"
                               required>
                    </div>
                </div>

                <!-- Birth Time Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label" for="id_hour">
                            <span class="label-text">出生时</span>
                        </label>
                        <input type="number" name="hour" id="id_hour"
                               x-model="formData.hour"
                               class="input input-bordered w-full"
                               min="0" max="23"
                               value="{{ form.hour.value|default:'' }}"
                               required>
                    </div>
                    <div class="form-control">
                        <label class="label" for="id_minute">
                            <span class="label-text">出生分</span>
                        </label>
                        <input type="number" name="minute" id="id_minute"
                               x-model="formData.minute"
                               class="input input-bordered w-full"
                               min="0" max="59"
                               value="{{ form.minute.value|default:'0' }}">
                    </div>
                </div>

                <!-- Gender Selection -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">性别</span>
                    </label>
                    <div class="flex gap-6">
                        <label class="label cursor-pointer gap-2">
                            <input type="radio" name="gender" value="male"
                                   x-model="formData.gender"
                                   class="radio radio-primary"
                                   {% if form.gender.value == 'male' or not form.gender.value %}checked{% endif %}>
                            <span class="label-text">男</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="radio" name="gender" value="female"
                                   x-model="formData.gender"
                                   class="radio radio-primary"
                                   {% if form.gender.value == 'female' %}checked{% endif %}>
                            <span class="label-text">女</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex flex-col gap-2">
                    <button type="submit" class="btn btn-primary w-full">
                        查看八字
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bazi Results Display -->
    {% if bazi %}
    <div class="card bg-base-100 shadow-xl"
         x-data="baziSaveComponent()"
         x-init="initBirthData({{ form.year.value }}, {{ form.month.value }}, {{ form.day.value }}, {{ form.hour.value }}, {{ form.minute.value|default:0 }}, {{ is_male|yesno:'true,false' }})">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title text-2xl">八字排盘</h2>
                <button type="button"
                        @click="if (!saved) { showSaveModal = true; saveName = ''; }"
                        :disabled="saving || saved"
                        class="btn btn-sm gap-2"
                        :class="saved ? 'btn-success' : 'btn-outline btn-primary'">
                    <span x-show="saving" class="loading loading-spinner loading-xs"></span>
                    <span x-text="saved ? '✓ 已保存' : '保存此资料'"></span>
                </button>
            </div>

            <!-- Main Bazi Table -->
            <div class="overflow-x-auto mb-6">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th></th>
                            <th class="text-center">时柱</th>
                            <th class="text-center">日柱</th>
                            <th class="text-center">月柱</th>
                            <th class="text-center">年柱</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>天干</th>
                            <td class="text-center text-lg font-semibold">{{ bazi.getTimeGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getDayGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getMonthGan }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getYearGan }}</td>
                        </tr>
                        <tr>
                            <th>地支</th>
                            <td class="text-center text-lg font-semibold">{{ bazi.getTimeZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getDayZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getMonthZhi }}</td>
                            <td class="text-center text-lg font-semibold">{{ bazi.getYearZhi }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Tabs -->
            <div x-data="{ activeTab: 'details' }">
                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{ 'tab-active': activeTab === 'details' }" @click="activeTab = 'details'">
                        详细计算
                    </a>
                    <a class="tab" :class="{ 'tab-active': activeTab === 'analysis' }" @click="activeTab = 'analysis'">
                        八字分析
                    </a>
                </div>

                <!-- Details Tab -->
                <div x-show="activeTab === 'details'" x-transition>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Summary Tables -->
                        <div class="space-y-6">
                            <!-- Wangxiang Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">旺相</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>五行</th>
                                                <th>旺相</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for wx, wangxiang in wang_xiang.items %}
                                                <tr><td>{{ wx }}</td><td>{{ wangxiang }}</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Wuxing Value Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">五行值</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>五行</th>
                                                <th>值</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for wx, value in wuxing_value.items %}
                                                <tr><td>{{ wx }}</td><td>{{ value|floatformat:2 }}</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Sheng Hao Table -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">生耗值</h4>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>值</th>
                                                <th>占比</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>生总值</td>
                                                <td>{{ sheng_hao.0|floatformat:2 }}</td>
                                                <td>{{ sheng_hao_percentage.0|floatformat:2 }}%</td>
                                            </tr>
                                            <tr>
                                                <td>耗总值</td>
                                                <td>{{ sheng_hao.1|floatformat:2 }}</td>
                                                <td>{{ sheng_hao_percentage.1|floatformat:2 }}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Pillar Details -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Year Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">年柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getYearGan zhi=bazi.getYearZhi gan_value=values.0.0 zhi_value=values.0.1 hidden_gans=hidden_gans.0 yinyang=yinyang.0 wuxing=wuxing.0 shishen=shishen.0 wx_value=wang_xiang_values.0 gl_value=gan_liang_values.0 %}
                                </div>
                            </div>

                            <!-- Month Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">月柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getMonthGan zhi=bazi.getMonthZhi gan_value=values.1.0 zhi_value=values.1.1 hidden_gans=hidden_gans.1 yinyang=yinyang.1 wuxing=wuxing.1 shishen=shishen.1 wx_value=wang_xiang_values.1 gl_value=gan_liang_values.1 %}
                                </div>
                            </div>

                            <!-- Day Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">日柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getDayGan zhi=bazi.getDayZhi gan_value=values.2.0 zhi_value=values.2.1 hidden_gans=hidden_gans.2 yinyang=yinyang.2 wuxing=wuxing.2 shishen=shishen.2 wx_value=wang_xiang_values.2 gl_value=gan_liang_values.2 %}
                                </div>
                            </div>

                            <!-- Hour Pillar -->
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h4 class="card-title text-lg">时柱计算</h4>
                                    {% include 'partials/bazi_table.html' with gan=bazi.getTimeGan zhi=bazi.getTimeZhi gan_value=values.3.0 zhi_value=values.3.1 hidden_gans=hidden_gans.3 yinyang=yinyang.3 wuxing=wuxing.3 shishen=shishen.3 wx_value=wang_xiang_values.3 gl_value=gan_liang_values.3 %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div x-show="activeTab === 'analysis'" x-transition>
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <ul class="space-y-4">
                                <li class="flex flex-wrap items-center gap-2">
                                    <span class="font-medium">主属性:</span>
                                    <span class="badge badge-lg badge-primary">{{ main_wuxing }}</span>
                                    <span class="badge badge-lg {% if sheng_hao.0 > sheng_hao.1 %}badge-success{% else %}badge-warning{% endif %}">
                                        {% if sheng_hao.0 > sheng_hao.1 %}身强{% else %}身弱{% endif %}
                                    </span>
                                </li>
                                <li>
                                    <span class="font-medium">生肖：</span>
                                    <span class="text-lg">{{ shengxiao }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">神煞：</span>
                                    <ul class="mt-2 ml-4 space-y-1">
                                        {% for name, desc in shensha_list %}
                                            <li>
                                                <span class="badge badge-outline mr-2">{{ name }}</span>
                                                <span class="text-base-content/80">{{ desc }}</span>
                                            </li>
                                        {% empty %}
                                            <li class="text-base-content/60">无显著神煞</li>
                                        {% endfor %}
                                    </ul>
                                </li>
                                <li>
                                    <span class="font-medium">配偶之性情：</span>
                                    <span>{{ partner_analyst }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">自身性格：</span>
                                    <span>{{ personality }}</span>
                                </li>
                                <li>
                                    <span class="font-medium">流年分析：</span>
                                    <div id="liunian-section" class="mt-2 p-3 bg-base-300 rounded-lg">
                                        <!-- Year Dropdown for Liunian -->
                                        <div class="flex flex-wrap items-center gap-4 mb-3">
                                            <label class="flex items-center gap-2">
                                                <span class="text-sm font-medium">选择流年：</span>
                                                <select id="liunian_year_select"
                                                        name="liunian_year"
                                                        class="select select-sm select-bordered"
                                                        hx-get="{% url 'liunian_partial' %}"
                                                        hx-target="#liunian-content"
                                                        hx-trigger="change"
                                                        hx-include="[name='birth_year'],[name='birth_month'],[name='birth_day'],[name='birth_hour'],[name='birth_minute'],[name='is_male']">
                                                    {% for year, ganzhi in liunian_year_options %}
                                                        <option value="{{ year }}" {% if year == selected_liunian_year %}selected{% endif %}>
                                                            {{ year }} {{ ganzhi }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </label>
                                            <span class="loading loading-spinner loading-sm htmx-indicator"></span>
                                        </div>
                                        <!-- Hidden fields to pass birth data for HTMX -->
                                        <input type="hidden" name="birth_year" value="{{ form.year.value }}">
                                        <input type="hidden" name="birth_month" value="{{ form.month.value }}">
                                        <input type="hidden" name="birth_day" value="{{ form.day.value }}">
                                        <input type="hidden" name="birth_hour" value="{{ form.hour.value }}">
                                        <input type="hidden" name="birth_minute" value="{{ form.minute.value|default:0 }}">
                                        <input type="hidden" name="is_male" value="{{ is_male }}">

                                        <!-- Liunian Content (updated via HTMX) -->
                                        <div id="liunian-content">
                                            {% include 'partials/liunian_content.html' %}
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Save Profile Modal (Unified - works for both anonymous and authenticated) -->
    <div class="modal" :class="{ 'modal-open': showSaveModal }"
         x-data="baziSaveComponent()"
         x-init="initBirthData({{ form.year.value|default:0 }}, {{ form.month.value|default:0 }}, {{ form.day.value|default:0 }}, {{ form.hour.value|default:0 }}, {{ form.minute.value|default:0 }}, {{ is_male|yesno:'true,false' }})">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">保存八字资料</h3>
            <div class="form-control mb-4">
                <label class="label" for="save_profile_name">
                    <span class="label-text">姓名 / 备注</span>
                </label>
                <input type="text" id="save_profile_name"
                       x-model="$root.saveName"
                       @keydown.enter.prevent="if ($root.saveName.trim()) { saveProfileWithName($root.saveName.trim()); showSaveModal = false; }"
                       class="input input-bordered w-full"
                       placeholder="例如：张三、爸爸、宝宝..."
                       autofocus>
            </div>
            <div class="modal-action">
                <button type="button" @click="showSaveModal = false" class="btn btn-ghost">取消</button>
                <button type="button"
                        @click="if ($root.saveName.trim()) { saveProfileWithName($root.saveName.trim()); showSaveModal = false; }"
                        :disabled="!$root.saveName.trim() || saving"
                        class="btn btn-primary">
                    <span x-show="saving" class="loading loading-spinner loading-xs"></span>
                    保存
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showSaveModal = false"></div>
    </div>
</div>
{% endblock %}

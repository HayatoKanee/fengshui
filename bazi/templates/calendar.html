{% extends 'base_content.html' %}

{% block content %}
<!-- Modal for detailed Bazi information -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-labelledby="dayDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailsModalLabel">八字详细信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="dayDetailsModalContent">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <h2 class="mb-4">八字日历</h2>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <label for="year-select" class="form-label">年份</label>
            <select class="form-select" id="year-select">
                {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="month-select" class="form-label">月份</label>
            <select class="form-select" id="month-select">
                {% for m in months %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}月</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="calendar-legend mb-3">
        <span class="legend-item"><span class="legend-dot good-dot"></span> 好日</span>
        <span class="legend-item ms-3"><span class="legend-dot neutral-dot"></span> 普通日</span>
        <span class="legend-item ms-3"><span class="legend-dot bad-dot"></span> 坏日</span>
    </div>
    
    <!-- FullCalendar will be rendered here -->
    <div id="calendar"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add FullCalendar CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/locales-all.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            initialView: 'dayGridMonth',
            locale: 'zh-cn',
            initialDate: '{{ year }}-{{ month|stringformat:"02d" }}-01',
            selectable: true,
            navLinks: true,
            dayMaxEvents: true,
            height: 'auto',
            // Handle date click events
            dateClick: function(info) {
                showHoursPopup(info.dateStr);
            },
            // Custom day cell content to include dots
            dayCellContent: function(args) {
                var dateNum = args.dayNumberText;
                var dateStr = args.date.getFullYear() + '-' + 
                             String(args.date.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(args.date.getDate()).padStart(2, '0');
                
                var dayEl = document.createElement('div');
                dayEl.classList.add('day-content');
                
                // Find quality for this day in our cached data
                if (window.calendarData && window.calendarData[dateStr]) {
                    var quality = window.calendarData[dateStr];
                    var dotEl = document.createElement('span');
                    dotEl.classList.add('quality-dot');
                    
                    if (quality === 'good') {
                        dotEl.classList.add('good-dot');
                    } else if (quality === 'bad') {
                        dotEl.classList.add('bad-dot');
                    } else {
                        dotEl.classList.add('neutral-dot');
                    }
                    
                    dayEl.appendChild(dotEl);
                }
                
                // Add date number
                var dateNumEl = document.createElement('span');
                dateNumEl.classList.add('date-number');
                dateNumEl.innerText = dateNum;
                dayEl.appendChild(dateNumEl);
                
                return { domNodes: [dayEl] };
            }
        });
        calendar.render();
        
        // Initialize calendar data cache object
        window.calendarData = {};
        
        // Load data for the initial month
        var initialYear = Number('{{ year }}');
        var initialMonth = Number('{{ month }}');
        loadMonthData(initialYear, initialMonth);
        
        // Add event listeners for year and month selection
        document.getElementById('year-select').addEventListener('change', function() {
            updateCalendar();
        });
        document.getElementById('month-select').addEventListener('change', function() {
            updateCalendar();
        });
        
        // Function to update calendar when year or month changes
        function updateCalendar() {
            var year = document.getElementById('year-select').value;
            var month = document.getElementById('month-select').value;
            
            // Update calendar date
            calendar.gotoDate(year + '-' + String(month).padStart(2, '0') + '-01');
            
            // Load data for the new month
            loadMonthData(year, month);
        }
        
        // Function to load month data from the server
        function loadMonthData(year, month) {
            // Clear previous calendar data cache
            window.calendarData = {};
            
            // Make AJAX call to get day qualities
            $.ajax({
                url: '/calendar/data/',
                type: 'POST',
                data: {
                    'year': year,
                    'month': month,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    // Process each day and cache its quality
                    data.days.forEach(function(day) {
                        // Calculate overall day quality
                        var goodHours = 0;
                        var badHours = 0;
                        var neutralHours = 0;
                        
                        day.hours.forEach(function(hour) {
                            if (hour.quality === 'good') goodHours++;
                            else if (hour.quality === 'bad') badHours++;
                            else neutralHours++;
                        });
                        
                        var dayQuality = 'neutral';
                        
                        if (goodHours > badHours && goodHours > neutralHours) {
                            dayQuality = 'good';
                        } else if (badHours > goodHours && badHours > neutralHours) {
                            dayQuality = 'bad';
                        }
                        
                        // Cache the quality for this date
                        var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day.day).padStart(2, '0');
                        window.calendarData[dateStr] = dayQuality;
                    });
                    
                    // Refresh the calendar to show the dots
                    calendar.render();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading calendar data:', error);
                }
            });
        }
        
        function getDayQualityLabel(quality) {
            switch(quality) {
                case 'good': return '好日';
                case 'bad': return '坏日';
                default: return '普通日';
            }
        }
        
        // Function to show time selection popup
        window.showHoursPopup = function(dateStr) {
            // Extract date components
            var dateParts = dateStr.split('-');
            var year = parseInt(dateParts[0]);
            var month = parseInt(dateParts[1]);
            var day = parseInt(dateParts[2]);
            
            // Find the event for this day
            var events = calendar.getEvents();
            var dayEvent = events.find(function(e) {
                var start = e.start;
                return start.getFullYear() === year && 
                       start.getMonth() + 1 === month && 
                       start.getDate() === day;
            });
            
            if (!dayEvent) return;
            
            // Create hour selection HTML
            var hours = dayEvent.extendedProps.hours || [];
            var html = '<h5>' + year + '年' + month + '月' + day + '日</h5>' +
                       '<div class="row">';
            
            var hourNames = [
                '子时 (23-1点)', '丑时 (1-3点)', '寅时 (3-5点)', '卯时 (5-7点)',
                '辰时 (7-9点)', '巳时 (9-11点)', '午时 (11-13点)', '未时 (13-15点)',
                '申时 (15-17点)', '酉时 (17-19点)', '戌时 (19-21点)', '亥时 (21-23点)'
            ];
            
            var hourValues = [0, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23];
            
            hours.forEach(function(hour, index) {
                html += '<div class="col-md-4 mb-2">' +
                        '<button class="btn btn-outline-secondary w-100 ' + hour.quality + '-day-btn" ' +
                        'onclick="showDayDetails(' + year + ', ' + month + ', ' + day + ', ' + hour.hour + ')">' +
                        hourNames[index] +
                        getQualityIcon(hour.quality) +
                        '</button>' +
                        '</div>';
            });
            
            html += '</div>';
            
            // Show modal with hour selection
            document.getElementById('dayDetailsModalLabel').innerText = '选择时间';
            document.getElementById('dayDetailsModalContent').innerHTML = html;
            
            // Show the modal
            var modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
            modal.show();
        }
        
        function getQualityIcon(quality) {
            switch(quality) {
                case 'good': 
                    return '<span class="circle-icon good-circle" title="好日"></span>';
                case 'bad': 
                    return '<span class="circle-icon bad-circle" title="坏日"></span>';
                default: 
                    return '<span class="circle-icon neutral-circle" title="普通日"></span>';
            }
        }
    });
    
    function showDayDetails(year, month, day, hour) {
        // Update the modal title
        document.getElementById('dayDetailsModalLabel').innerText = year + '年' + month + '月' + day + '日 ' + hour + '时 八字详细';
        
        // Show loading spinner
        document.getElementById('dayDetailsModalContent').innerHTML = 
            '<div class="text-center">' +
            '<div class="spinner-border" role="status">' +
            '<span class="visually-hidden">Loading...</span>' +
            '</div>' +
            '</div>';
        
        // Load the details via AJAX
        $.ajax({
            url: "{% url 'bazi_detail' %}",
            type: "POST",
            data: {
                'year': year,
                'month': month,
                'day': day,
                'hour': hour,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                document.getElementById('dayDetailsModalContent').innerHTML = response;
            },
            error: function(xhr, status, error) {
                document.getElementById('dayDetailsModalContent').innerHTML = 
                    '<div class="alert alert-danger">' +
                    '加载失败: ' + error +
                    '</div>';
            }
        });
    }
</script>
<style>
    /* Custom FullCalendar Day Cell Formatting */
    .day-content {
        padding: 5px;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .date-number {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin-left: 4px;
    }
    
    .quality-dot, .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .legend-dot {
        margin-right: 5px;
        vertical-align: middle;
    }
    
    .good-dot {
        background-color: #ff6666;
    }
    
    .neutral-dot {
        background-color: transparent;
        border: 1px solid #ff6666;
    }
    
    .bad-dot {
        background-color: #333333;
    }
    
    .fc-day-today {
        background-color: #fffbe6 !important;
    }
    
    /* Legend styling */
    .legend-item {
        font-size: 14px;
        vertical-align: middle;
    }

    /* Circle styles for day indicators */
    .circle-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-left: 5px;
    }
    .good-circle {
        background-color: #ff6666;
    }
    .neutral-circle {
        background-color: #ffffff;
        border: 1px solid #ff6666;
    }
    .bad-circle {
        background-color: #333333;
    }
</style>
{% endblock %} 